# 1. 概述

红黑树是一种自平衡的**二叉查找树**，是一种高效的查找树。它是由 Rudolf Bayer 于1978年发明，在当时被称为`对称二叉 B 树(symmetric binary B-trees)`。后来，在1978年被 Leo J. Guibas 和 Robert Sedgewick 修改为如今的`红黑树`。红黑树具有良好的效率，它可在 `O(logN)` 时间内完成查找、增加、删除等操作。因此，红黑树在业界应用很广泛，比如 Java 中的 TreeMap，JDK 1.8 中的 HashMap、C++ STL 中的 map 均是基于红黑树结构实现的。考虑到红黑树是一种被广泛应用的数据结构，所以我们很有必要去弄懂它。

# 2. 红黑树的性质

学过二叉查找树的同学都知道，普通的二叉查找树在极端情况下可退化成链表，此时的增删查效率都会比较低下。为了避免这种情况，就出现了一些自平衡的查找树，比如 AVL，红黑树等。这些自平衡的查找树通过定义一些性质，将任意节点的左右子树高度差控制在规定范围内，以达到平衡状态。以红黑树为例，红黑树通过如下的性质定义实现自平衡：

1. 每个节点是要么是**红色**或要么是**黑色**。
2. 根节点是**黑色**。
3. 所有叶子都是**黑色**（叶子是**NIL**节点）。
4. 每个**红色**节点必须有两个**黑色**的子节点。（从每个叶子到根的所有路径上不能有两个连续的红色节点。）
5. 从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点（简称黑高）。

从性质5又可以推出性质5.1：如果一个节点存在黑子节点，那么该节点必定存在两个子节点。

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632586117.png" alt="image-20210926000836886" style="zoom:50%;" />

红黑树并不是一个完美平衡二叉树，从图上可以看到，根节点P的左子树显然比右子树高。但左子树和右子树的黑色节点的层数是相等的，也就是任意一个节点到每个叶子节点的路径都包含数量相同的黑色节点（性质5）。

所以，我们叫红黑树这种平衡为**黑色完美平衡**。

红黑树的性质讲完了，只要这棵树满足以上性质，这棵树就是趋近于平衡状态的。不要问为什么，发明红黑树的科学家就是这么牛逼！

前面讲到红黑树能自平衡，它靠的是什么？三种操作：**左旋、右旋和变色**。

1. 变色：节点的颜色可以由红变黑或由黑变红。
2. 左旋：以某个节点为支点（旋转节点），其右子节点变为旋转节点的父节点，右子节点的左子节点变为旋转节点的右子节点，右子节点保持不变。
3. 右旋：以某个节点为支点（旋转节点），其左子节点变为旋转节点的父节点，左子节点的右子节点变为旋转节点的左子节点，左子节点保持不变。

以上第2和第3种操作可以概括为：**我把我距离你最近的儿子给你，我就能变成你的爸爸**。

对P节点进行左旋操作：

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632623002.png" alt="image-20210926102322351" style="zoom:50%;" />

左旋P节点的步骤为：

1. V节点上去，V节点变为P节点的父节点
2. P节点下来，P节点变为V的左子节点
3. V节点的左子节点R挂到P节点的右子节点上

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632625635.png" alt="image-20210926110715626" style="zoom:50%;" />

对P节点进行右旋操作：

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632635246.png" alt="image-20210926134726785" style="zoom:50%;" />

右旋P节点的步骤为：

1. F节点上去，F节点变为P节点的父节点
2. P节点下来，P节点变为F的右子节点
3. F节点的右子节点R挂到P节点的左子节点上

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632635087.png" alt="image-20210926134447259" style="zoom:50%;" />

总的来说，左旋是为了降低右子树右边的高度，右旋是为了降低左子树左边的高度。

**红黑树查找**：

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/26/1632671826.png" alt="image-20210926235706766" style="zoom:50%;" />

因为插入的时候会自平衡，所以红黑树的查找效率会保持在一个不错的区间。以查找50为例：

1. 50小于80，所以80的右子树不用考虑了
2. 来到80的左子树40
3. 50大于40，所以40的左子树20就不用考虑了
4. 来到40的右子树60
5. 50小于60，所以60的右子树不用考虑了
6. 来到60的左子树50，50与50相等，查找到了，返回。

**红黑树插入**：

插入操作包括两个部分：

1. 查找插入的位置
2. 插入后自平衡

注意：插入节点，必须为红色。理由很简单，在要插入位置的父节点（如果存在）为黑色节点时，如果插入节点也是黑色，那么插入位置所在的子树黑色节点总是多1，必须要做自平衡。但是，如果插入节点是红色，红黑树的黑色完美平衡（上面的性质5）没有被破坏，不需要做自平衡操作。

在开始每个情景的讲解前，我们还是先来约定一下：

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/27/1632673422.png" alt="image-20210927002342792" style="zoom:50%;" />

情况一：**红黑树为空树**

最简单一种情况，直接把插入节点作为根节点就可以。

注意：根据红黑树性质2，根节点为黑色，还需要把插入节点颜色变为黑色。

情况二：**插入的key已存在**

处理：更新当前节点的值，为插入节点的值。

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/27/1632674202.png" alt="image-20210927003642213" style="zoom:67%;" />

情况三：**插入节点的父节点为黑色**

由于插入的节点是红色的，当父节点为黑色时，并不会影响红黑树的黑色平衡，直接插入即可，无需做自平衡。

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/27/1632674594.png" alt="image-20210927004314952" style="zoom:50%;" />

情况四：**插入节点的父节点为红色**

再次回想下红黑树的性质2：根节点是黑色，如果插入节点的父节点为红节点，那么该父节点不可能为根节点，所以插入节点总是存在祖父节点。

这一点很关键，因为后续的操作肯定需要祖父节点的参与。

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632758475.png" alt="image-20210928000115587" style="zoom:50%;" />

**情况4.1：叔叔节点存在并且为红色节点**

根据**红黑树性质4可知，红色节点不能相连 ==》祖父节点一定为黑色节点。**

因为不可以同时存在两个相连的红色节点。那么此时该插入子树的红黑层数是：黑红红（祖父-父-当前），显然最简单的处理方式是把其改为：红黑红。

处理：

1. 将P和U节点改为黑色
2. 将PP改为红色
3. 将PP设置为当前节点，进行后续处理

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632759616.png" alt="image-20210928002016549" style="zoom:50%;" />

可以看到，我们把PP节点设置为红色了，如果PP的父节点是黑色，那么无需再做任何处理。

但假如PP的父节点是红色，则违反红黑树性质了，所以需要将PP设置为当前节点，继续做插入操作自平衡处理，直到平衡为止。

**情况4.2：叔叔节点不存在或为黑色节点，并且插入节点的父节点是祖父节点的左子节点**

**注意：单纯从插入前看，叔叔节点非红即空（NIL节点），否则的话破坏了红黑树性质5，此路径会比其他路径多一个黑色节点。**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632759711.png" alt="image-20210928002151463" style="zoom:50%;" />

**情况4.2.1：新插入节点，为其父节点的左子节点（LL双红）**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632760166.png" alt="image-20210928002926530" style="zoom:50%;" />

处理：

1. 变红色：将P设置成黑色，将PP设置成红色
2. 对PP节点进行**右旋**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202110/10/1633797930.png" alt="image-20211010004530276" style="zoom:50%;" />

**情况4.2.2：新插入节点，为其父节点的右子节点（LR双红）**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632760839.png" alt="image-20210928004039267" style="zoom:50%;" />

处理：

1. 对P进行左旋
2. 将P设置为当前节点，得到情况4.2.1LL双红情况
3. 按照情况4.2.1处理（1.变色，2.右旋PP）

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202110/10/1633798241.png" alt="image-20211010005041366" style="zoom:50%;" />

**情况4.3：叔叔节点不存在或为黑色节点，并且插入节点的父节点是祖父节点的右子节点**

该情况对应情况4.2，只是方向反转。

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632833538.png" alt="image-20210928205218624" style="zoom:50%;" />

**情况4.3.1：新插入节点，为其父节点的右子节点（RR双红）**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/28/1632833767.png" alt="image-20210928205607922" style="zoom:50%;" />

处理：

1. 变红色：将P设置成黑色，将PP设置成红色
2. 对PP节点进行**左旋**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/29/1632845906.png" alt="image-20210929001826704" style="zoom:50%;" />

**情况4.3.2：新插入节点，为其父节点的左子节点（RL双红）**

<img src="http://blog-1259650185.cosbj.myqcloud.com/img/202109/29/1632846124.png" alt="image-20210929002204936" style="zoom:50%;" />

![image-20210929002739453](http://blog-1259650185.cosbj.myqcloud.com/img/202109/29/1632846459.png)

全景案例分析：

![](http://blog-1259650185.cosbj.myqcloud.com/img/202110/09/1633710211.png)



















# 参考

[田小波的技术博客-红黑树详细分析](https://www.tianxiaobo.com/2018/01/11/%E7%BA%A2%E9%BB%91%E6%A0%91%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/)

